{% extends "base.html" %}

{% block title %}PWA Diagnostics{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/assets/css/pwa.css" />
{% endblock %}

{% block content %}
<section class="pwa-diag">
  <header>
    <span class="eyebrow">Tools</span>
    <h1>PWA Diagnostics</h1>
    <p class="lead">
      Quick status for service worker, manifest, cache, and install state.
    </p>
    <a href="/" class="btn btn-ghost">Back home</a>
  </header>

  <div class="diag-grid">
    <article class="diag-card">
      <h2>App Status</h2>
      <ul>
        <li><strong>Online:</strong> <span id="net-status">Checking…</span></li>
        <li><strong>Display mode:</strong> <span id="display-mode">Checking…</span></li>
      </ul>
    </article>

    <article class="diag-card">
      <h2>Service Worker</h2>
      <ul>
        <li><strong>Supported:</strong> <span id="sw-support">Checking…</span></li>
        <li><strong>Status:</strong> <span id="sw-status">Checking…</span></li>
        <li><strong>Scope:</strong> <span id="sw-scope">—</span></li>
        <li><strong>State:</strong> <span id="sw-state">—</span></li>
      </ul>
    </article>

    <article class="diag-card">
      <h2>Manifest</h2>
      <ul>
        <li><strong>Link:</strong> <span id="manifest-link">Checking…</span></li>
        <li><strong>Name:</strong> <span id="manifest-name">—</span></li>
        <li><strong>Start URL:</strong> <span id="manifest-start">—</span></li>
      </ul>
    </article>

    <article class="diag-card">
      <h2>Cache</h2>
      <ul>
        <li><strong>Supported:</strong> <span id="cache-support">Checking…</span></li>
        <li><strong>Stores:</strong> <span id="cache-keys">—</span></li>
        <li><strong>Total entries:</strong> <span id="cache-total">—</span></li>
      </ul>
      <div id="cache-details" class="cache-details"></div>
    </article>

    <article class="diag-card">
      <h2>Offline Quotes</h2>
      <ul>
        <li><strong>Stored quotes:</strong> <span id="quote-count">Checking…</span></li>
        <li><strong>Sync status:</strong> <span id="quote-sync">Checking…</span></li>
        <li><strong>Last sync:</strong> <span id="quote-sync-time">—</span></li>
        <li><strong>Cache freshness:</strong> <span id="quote-freshness">—</span></li>
        <li><strong>Last sync error:</strong> <span id="quote-sync-error">None</span></li>
      </ul>
    </article>

  </div>
</section>

<script>
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  const updateNetworkStatus = () => {
    setText("net-status", navigator.onLine ? "Online" : "Offline");
  };

  const getDisplayMode = () => {
    if (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) {
      return "Standalone";
    }
    if (window.matchMedia && window.matchMedia("(display-mode: minimal-ui)").matches) {
      return "Minimal UI";
    }
    if (window.navigator.standalone) {
      return "Standalone (iOS)";
    }
    return "Browser";
  };

  const loadManifest = async () => {
    const link = document.querySelector('link[rel="manifest"]');
    if (!link) {
      setText("manifest-link", "Not found");
      return;
    }

    setText("manifest-link", link.href);
    try {
      const res = await fetch(link.href, { cache: "no-store" });
      if (!res.ok) throw new Error("bad response");
      const data = await res.json();
      setText("manifest-name", data.name || data.short_name || "—");
      setText("manifest-start", data.start_url || "—");
    } catch (err) {
      setText("manifest-name", "Failed to load");
      setText("manifest-start", "—");
    }
  };

  const loadServiceWorker = async () => {
    if (!("serviceWorker" in navigator)) {
      setText("sw-support", "No");
      setText("sw-status", "Not supported");
      return;
    }

    setText("sw-support", "Yes");
    try {
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) {
        setText("sw-status", "Not registered");
        return;
      }

      setText("sw-status", "Registered");
      setText("sw-scope", reg.scope || "—");
      const state = reg.active?.state || reg.installing?.state || reg.waiting?.state;
      setText("sw-state", state || "Unknown");
    } catch (err) {
      setText("sw-status", "Error");
    }
  };

  const loadCache = async () => {
    if (!("caches" in window)) {
      setText("cache-support", "No");
      return;
    }

    setText("cache-support", "Yes");
    try {
      const keys = await caches.keys();
      setText("cache-keys", keys.length ? keys.join(", ") : "None");
      let total = 0;
      const details = [];

      await Promise.all(
        keys.map(async (key) => {
          const cache = await caches.open(key);
          const entries = await cache.keys();
          total += entries.length;
          details.push(`${key}: ${entries.length} items`);
        })
      );

      setText("cache-total", String(total));
      const detailsEl = document.getElementById("cache-details");
      if (detailsEl) {
        detailsEl.textContent = details.length ? details.join(" · ") : "";
      }
    } catch (err) {
      setText("cache-keys", "Error");
    }
  };

  const loadQuoteStats = async () => {
    if (!window.qbPwa?.getLocalStats) {
      return null;
    }

    const stats = await window.qbPwa.getLocalStats();
    if (!stats) {
      return null;
    }

    const totalLabel = stats.total ? ` / ${stats.total}` : "";
    setText("quote-count", `${stats.count}${totalLabel}`);
    setText("quote-sync", stats.complete ? "Complete" : "In progress");

    if (stats.lastRun) {
      const dt = new Date(stats.lastRun);
      setText("quote-sync-time", dt.toLocaleString());
    } else {
      setText("quote-sync-time", "—");
    }
    setText("quote-freshness", stats.stale ? "Stale" : "Fresh");
    setText("quote-sync-error", stats.lastError || "None");

    return stats;
  };

  const scheduleQuoteStats = (attempt = 0) => {
    if (attempt === 0) {
      setText("quote-count", "Waiting…");
      setText("quote-sync", "Waiting…");
    }
    loadQuoteStats().then((stats) => {
      if (stats) return;
      if (attempt >= 10) {
        setText("quote-count", "Unavailable");
        setText("quote-sync", "Unavailable");
        return;
      }
      setTimeout(() => scheduleQuoteStats(attempt + 1), 300);
    });
  };


  updateNetworkStatus();
  setText("display-mode", getDisplayMode());
  window.addEventListener("online", updateNetworkStatus);
  window.addEventListener("offline", updateNetworkStatus);

  loadManifest();
  loadServiceWorker();
  loadCache();
  scheduleQuoteStats();
</script>
{% endblock %}
