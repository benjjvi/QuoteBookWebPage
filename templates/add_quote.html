{% extends "base.html" %}

{% block title %}Add a Quote{% endblock %}

{% block extra_css %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"
/>
<link
  rel="stylesheet"
  href="/static/assets/css/add-quote.css"
/>
{% endblock %}

{% block content %}
<section class="add-quote-page">
  <div class="offline-card offline-only">
    <span class="eyebrow">Offline</span>
    <h1>Adding quotes is unavailable offline</h1>
    <p class="lead">
      Reconnect to the internet to add new quotes and keep everything in sync.
    </p>
    <a href="/" class="btn btn-ghost">Back home</a>
  </div>

  <div class="add-quote-card offline-hide">
    <header class="add-quote-header">
      <span class="eyebrow">New entry</span>
      <h1>Add a Quote</h1>
      <p class="lead">
        Capture the line, the context, and the people who said it. The rest is
        just atmosphere.
      </p>
    </header>

    <div class="add-quote-body">
      <form class="quote-form" method="POST" action="/add_quote">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="field">
          <label for="quote_text">Quote</label>
          <textarea
            id="quote_text"
            name="quote_text"
            rows="5"
            placeholder="Type the quote exactly as it was said..."
            required
          ></textarea>
          <p class="field-hint">Required. Keep it verbatim if you can.</p>
        </div>

        <div class="field">
          <label for="author_info">Who said it?</label>
          <input
            id="author_info"
            name="author_info"
            type="text"
            placeholder="e.g. Sam, Priya, and Lee"
            autocomplete="name"
          />
          <p class="field-hint">
            Separate multiple names with commas or the word “and”.
          </p>
        </div>

        <div class="field">
          <label for="context">Context</label>
          <textarea
            id="context"
            name="context"
            rows="3"
            placeholder="Optional: where, when, or what was happening"
          ></textarea>
          <p class="field-hint">Optional. Helps future-you remember.</p>
        </div>

        <div class="field">
          <label for="tags">Tags</label>
          <input
            id="tags"
            name="tags"
            type="text"
            placeholder="e.g. work, chaos, coffee"
            autocomplete="off"
          />
          <p class="field-hint">
            Optional. Comma-separated topics. If blank, AI can suggest tags.
          </p>
        </div>

        <div class="field">
          <label for="quote_datetime">Date and time</label>
          <input
            id="quote_datetime"
            name="quote_datetime"
            type="text"
            placeholder="Leave blank for current date/time"
            autocomplete="off"
          />
          <p class="field-hint">
            Optional. Uses UK time. If empty, current date/time is used.
          </p>
        </div>

        <div class="form-actions">
          <a href="/" class="btn btn-ghost">Back home</a>
          <button type="submit" class="btn btn-primary">Add quote</button>
        </div>
      </form>

      <aside class="guide-panel" aria-label="Tips for adding a quote">
        <h2>Quick tips</h2>
        <ul class="tips-list">
          <li>Use exact phrasing for the best search results.</li>
          <li>Context can be a place, a moment, or a short setup.</li>
          <li>Multiple authors: “Ben, James, and Kim”.</li>
        </ul>

        <div class="example-card">
          <p class="example-label">Example entry</p>
          <p class="example-quote">“We don’t need a plan, we have vibes.”</p>
          <p class="example-meta">— Alex and Jordan · Hallway, 2am</p>
        </div>

        <div class="chip-row">
          <span class="chip">Auto timestamped</span>
          <span class="chip">Saved instantly</span>
          <span class="chip">Searchable later</span>
        </div>
      </aside>
    </div>
  </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  (() => {
    const form = document.querySelector(".quote-form");
    const quoteTextInput = document.getElementById("quote_text");
    const authorInput = document.getElementById("author_info");
    const contextInput = document.getElementById("context");
    const tagsInput = document.getElementById("tags");
    const dateInput = document.getElementById("quote_datetime");
    const draftKey = "qb_add_quote_draft_v1";

    if (!form || !quoteTextInput || !authorInput || !contextInput || !tagsInput || !dateInput) return;

    const saveDraft = () => {
      const payload = {
        quote_text: quoteTextInput.value || "",
        author_info: authorInput.value || "",
        context: contextInput.value || "",
        tags: tagsInput.value || "",
        quote_datetime: dateInput.value || "",
      };
      localStorage.setItem(draftKey, JSON.stringify(payload));
    };

    const restoreDraft = () => {
      const raw = localStorage.getItem(draftKey);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (!quoteTextInput.value && data.quote_text) quoteTextInput.value = data.quote_text;
        if (!authorInput.value && data.author_info) authorInput.value = data.author_info;
        if (!contextInput.value && data.context) contextInput.value = data.context;
        if (!tagsInput.value && data.tags) tagsInput.value = data.tags;
        if (!dateInput.value && data.quote_datetime) dateInput.value = data.quote_datetime;
      } catch (_err) {
        localStorage.removeItem(draftKey);
      }
    };

    if (typeof flatpickr === "function") {
      flatpickr(dateInput, {
        enableTime: true,
        time_24hr: true,
        dateFormat: "Y-m-d\\TH:i",
        altInput: true,
        altFormat: "j F Y, H:i",
      });
    }

    restoreDraft();

    quoteTextInput.addEventListener("input", saveDraft);
    authorInput.addEventListener("input", saveDraft);
    contextInput.addEventListener("input", saveDraft);
    tagsInput.addEventListener("input", saveDraft);
    dateInput.addEventListener("change", saveDraft);

    form.addEventListener("submit", () => {
      localStorage.removeItem(draftKey);
    });
  })();
</script>
{% endblock %}
