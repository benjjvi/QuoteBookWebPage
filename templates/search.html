{% extends "base.html" %}

{% block title %}Search Quotes{% endblock %}

{% block extra_css %}
<link
  rel="stylesheet"
  href="/static/assets/css/search.css"
/>
{% endblock %}

{% block content %}
<section class="search-page">
  <header class="search-header">
    <div>
      <span class="eyebrow">Search</span>
      <h1>Search Quotes</h1>
      <p class="lead">Find a line by phrase, speaker, or context.</p>
    </div>
    <a href="/" class="btn btn-ghost">Back home</a>
  </header>

  <form class="search-form" method="get" id="searchForm">
    <label for="q">Search query</label>
    <div class="search-input">
      <input
        id="q"
        type="text"
        name="q"
        placeholder="e.g. hallway, James, or a specific line"
        value="{{ query }}"
        autofocus
      />
      <button type="submit" class="btn btn-primary">Search</button>
    </div>
    <label for="searchTag">Tag filter</label>
    <div class="search-input">
      <select id="searchTag" name="tag">
        <option value="">All tags</option>
        {% for topic, count in tags %}
          <option value="{{ topic }}" {% if topic == selected_tag %}selected{% endif %}>
            #{{ topic }} ({{ count }})
          </option>
        {% endfor %}
      </select>
    </div>
    <p class="hint offline-hide">Tip: searching a speaker name will also match their quotes.</p>
    <p class="hint offline-only">
      Offline mode searches the quotes currently cached on this device.
    </p>
  </form>

  <div
    class="results-header"
    id="resultsHeader"
    {% if not (query or selected_tag) %}hidden{% endif %}
  >
    <h2 id="resultsTitle">
      {% if query and selected_tag %}
        {{ results|length }} results for “{{ query }}” tagged #{{ selected_tag }}
      {% elif query %}
        {{ results|length }} results for “{{ query }}”
      {% elif selected_tag %}
        {{ results|length }} results tagged #{{ selected_tag }}
      {% endif %}
    </h2>
  </div>

  <div class="results-grid" id="resultsGrid">
    {% for q in results %}
      <article class="result-card">
        <div class="quote-text">“{{ q.quote }}”</div>
        <div class="quote-meta">
          <span class="quote-author">{{ q.authors | join(", ") }}</span>
          <span class="dot">•</span>
          <span>{{ q.timestamp | uk_date }}</span>
          <span class="dot">•</span>
          <span>{{ q.timestamp | uk_time }}</span>
        </div>
        {% if q.context %}
          <p class="quote-context">{{ q.context }}</p>
        {% endif %}
        {% if q.tags %}
          <div class="tag-row">
            {% for topic in q.tags %}
              <a href="/search?tag={{ topic | urlencode }}" class="tag-chip">#{{ topic }}</a>
            {% endfor %}
          </div>
        {% endif %}
        <a href="/quote/{{ q.id }}" class="btn btn-primary">
          View
        </a>
      </article>
    {% endfor %}
  </div>

  <div
    class="empty-state"
    id="resultsEmpty"
    {% if not ((query or selected_tag) and not results) %}hidden{% endif %}
  >
    <h2>No quotes found</h2>
    <p>Try a different phrase or a speaker name.</p>
  </div>
</section>

<script>
  const searchForm = document.getElementById("searchForm");
  const queryInput = document.getElementById("q");
  const tagInput = document.getElementById("searchTag");
  const resultsHeader = document.getElementById("resultsHeader");
  const resultsTitle = document.getElementById("resultsTitle");
  const resultsGrid = document.getElementById("resultsGrid");
  const resultsEmpty = document.getElementById("resultsEmpty");

  const escapeHtml = (value) => {
    const div = document.createElement("div");
    div.textContent = value ?? "";
    return div.innerHTML;
  };

  const formatDate = (epochSeconds) => {
    const date = new Date((Number(epochSeconds) || 0) * 1000);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      day: "2-digit",
      month: "long",
      year: "numeric",
    }).format(date);
  };

  const formatTime = (epochSeconds) => {
    const date = new Date((Number(epochSeconds) || 0) * 1000);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    }).format(date);
  };

  const renderResults = (query, results, tag) => {
    if (!resultsHeader || !resultsTitle || !resultsGrid || !resultsEmpty) return;

    const normalizedQuery = String(query || "").trim();
    const normalizedTag = String(tag || "").trim();
    if (!normalizedQuery && !normalizedTag) {
      resultsHeader.hidden = true;
      resultsTitle.textContent = "";
      resultsGrid.innerHTML = "";
      resultsEmpty.hidden = true;
      return;
    }

    const count = Array.isArray(results) ? results.length : 0;
    const resultWord = count === 1 ? "result" : "results";
    if (normalizedQuery && normalizedTag) {
      resultsTitle.textContent = `${count} ${resultWord} for “${normalizedQuery}” tagged #${normalizedTag}`;
    } else if (normalizedQuery) {
      resultsTitle.textContent = `${count} ${resultWord} for “${normalizedQuery}”`;
    } else {
      resultsTitle.textContent = `${count} ${resultWord} tagged #${normalizedTag}`;
    }
    resultsHeader.hidden = false;

    if (!count) {
      resultsGrid.innerHTML = "";
      resultsEmpty.hidden = false;
      return;
    }

    resultsGrid.innerHTML = results
      .map((quote) => {
        const quoteText = escapeHtml(quote.quote || "");
        const authorText = Array.isArray(quote.authors)
          ? quote.authors.map((author) => escapeHtml(author)).join(", ")
          : "";
        const contextHtml = quote.context
          ? `<p class="quote-context">${escapeHtml(quote.context)}</p>`
          : "";
        const tagsHtml =
          Array.isArray(quote.tags) && quote.tags.length
            ? `<div class="tag-row">${quote.tags
                .map(
                  (topic) =>
                    `<a class="tag-chip" href="/search?tag=${encodeURIComponent(
                      String(topic),
                    )}">#${escapeHtml(topic)}</a>`,
                )
                .join("")}</div>`
            : "";
        return `
          <article class="result-card">
            <div class="quote-text">“${quoteText}”</div>
            <div class="quote-meta">
              <span class="quote-author">${authorText}</span>
              <span class="dot">•</span>
              <span>${formatDate(quote.timestamp)}</span>
              <span class="dot">•</span>
              <span>${formatTime(quote.timestamp)}</span>
            </div>
            ${contextHtml}
            ${tagsHtml}
            <a href="/quote/${encodeURIComponent(quote.id)}" class="btn btn-primary">View</a>
          </article>
        `;
      })
      .join("");
    resultsEmpty.hidden = true;
  };

  const updateQueryInUrl = (query, tag) => {
    const params = new URLSearchParams(window.location.search);
    if (query) {
      params.set("q", query);
    } else {
      params.delete("q");
    }
    if (tag) {
      params.set("tag", tag);
    } else {
      params.delete("tag");
    }
    const queryString = params.toString();
    const nextUrl = queryString
      ? `${window.location.pathname}?${queryString}`
      : window.location.pathname;
    window.history.replaceState({}, "", nextUrl);
  };

  const runOfflineSearch = async (query, tag) => {
    if (!window.qbPwa?.searchOfflineQuotes) return false;
    const normalizedQuery = String(query || "").trim();
    const normalizedTag = String(tag || "").trim();
    const results = normalizedQuery || normalizedTag
      ? await window.qbPwa.searchOfflineQuotes(normalizedQuery, { tag: normalizedTag })
      : [];
    renderResults(normalizedQuery, results, normalizedTag);
    updateQueryInUrl(normalizedQuery, normalizedTag);
    return true;
  };

  const scheduleOfflineSearch = (attempt = 0) => {
    if (navigator.onLine) return;

    if (window.qbPwa?.searchOfflineQuotes) {
      runOfflineSearch(queryInput?.value || "", tagInput?.value || "");
      return;
    }

    if (attempt < 12) {
      setTimeout(() => scheduleOfflineSearch(attempt + 1), 300);
    }
  };

  searchForm?.addEventListener("submit", (event) => {
    if (navigator.onLine) return;
    event.preventDefault();
    runOfflineSearch(queryInput?.value || "", tagInput?.value || "");
  });

  window.addEventListener("offline", () => scheduleOfflineSearch());
  window.addEventListener("load", () => scheduleOfflineSearch());
</script>
{% endblock %}
