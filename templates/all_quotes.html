{% extends "base.html" %}

{% block title %}All Quotes{% endblock %}

{% block extra_css %}
<link
  rel="stylesheet"
  href="/static/assets/css/all-quotes.css"
/>
{% endblock %}

{% block content %}
<section class="all-quotes-page" data-per-page="{{ per_page }}">
  <header class="page-header">
    <div>
      <span class="eyebrow">Library</span>
      <h1>All Quotes</h1>
      <p class="lead">Every line, every legend, all in one place.</p>
    </div>
    <a href="/" class="btn btn-ghost">Back home</a>
  </header>

  <div class="controls-bar">
    <form method="get" class="filter-form">
      <input type="hidden" name="page" value="1" />
      <div class="filter-group">
        <label for="speaker">Filter by speaker</label>
        <div class="select-wrap">
          <select
            name="speaker"
            id="speaker"
            class="speaker-select"
            onchange="this.form.submit()"
          >
            <option value="">All speakers</option>
            {% for spk, count in speakers %}
              <option
                value="{{ spk }}"
                {% if spk == selected_speaker %}selected{% endif %}
              >
                {{ spk }} ({{ count }})
              </option>
            {% endfor %}
          </select>
          <span class="select-icon">▾</span>
        </div>
      </div>
      <div class="filter-group">
        <label for="order">Sort by</label>
        <div class="select-wrap">
          <select
            name="order"
            id="order"
            class="speaker-select"
            onchange="this.form.submit()"
          >
            <option value="oldest" {% if sort_order != "newest" %}selected{% endif %}>
              Oldest first
            </option>
            <option value="newest" {% if sort_order == "newest" %}selected{% endif %}>
              Newest first
            </option>
          </select>
          <span class="select-icon">▾</span>
        </div>
      </div>
      <div class="filter-group">
        <label for="tag">Filter by tag</label>
        <div class="select-wrap">
          <select
            name="tag"
            id="tag"
            class="speaker-select"
            onchange="this.form.submit()"
          >
            <option value="">All tags</option>
            {% for topic, count in tags %}
              <option value="{{ topic }}" {% if topic == selected_tag %}selected{% endif %}>
                #{{ topic }} ({{ count }})
              </option>
            {% endfor %}
          </select>
          <span class="select-icon">▾</span>
        </div>
      </div>
      <noscript><button type="submit" class="btn btn-primary">Filter</button></noscript>
    </form>

    {% if selected_speaker or selected_tag %}
      <div class="filter-pill">
        <span>Showing:</span>
        {% if selected_speaker %}
          <strong>{{ selected_speaker }}</strong>
        {% endif %}
        {% if selected_tag %}
          <strong>#{{ selected_tag }}</strong>
        {% endif %}
        <a href="/all_quotes?order={{ sort_order }}" class="pill-clear">Clear</a>
      </div>
    {% endif %}
  </div>

  <div class="quote-grid">
    {% for q in quotes %}
      <article class="quote-card">
        <div class="quote-text">“{{ q.quote }}”</div>
        <div class="quote-meta">
          <span class="quote-author">{{ q.authors | join(", ") }}</span>
          <span class="dot">•</span>
          <span>{{ q.timestamp | uk_date }}</span>
          <span class="dot">•</span>
          <span>{{ q.timestamp | uk_time }}</span>
        </div>
        {% if q.context %}
          <p class="quote-context">{{ q.context }}</p>
        {% endif %}
        {% if q.tags %}
          <div class="tag-row">
            {% for topic in q.tags %}
              <a href="/all_quotes?order={{ sort_order }}&tag={{ topic | urlencode }}" class="tag-chip">#{{ topic }}</a>
            {% endfor %}
          </div>
        {% endif %}
        <a href="/quote/{{ q.id }}" class="btn btn-primary">
          View
        </a>
      </article>
    {% else %}
      <div class="empty-state">
        <h2>No quotes found</h2>
        <p>Try another speaker or clear the filter.</p>
      </div>
    {% endfor %}
  </div>

  {% if total_pages > 1 %}
    <div class="pagination">
      {% if page > 1 %}
        <a
          href="/all_quotes?order={{ sort_order }}&page={{ page-1 }}{% if selected_speaker %}&speaker={{ selected_speaker | urlencode }}{% endif %}{% if selected_tag %}&tag={{ selected_tag | urlencode }}{% endif %}"
          class="btn btn-ghost"
        >
          ← Prev
        </a>
      {% endif %}

      <form method="get" class="page-jump">
        {% if selected_speaker %}
          <input type="hidden" name="speaker" value="{{ selected_speaker }}" />
        {% endif %}
        {% if sort_order %}
          <input type="hidden" name="order" value="{{ sort_order }}" />
        {% endif %}
        {% if selected_tag %}
          <input type="hidden" name="tag" value="{{ selected_tag }}" />
        {% endif %}
        <label>
          Page
          <input
            type="number"
            name="page"
            value="{{ page }}"
            min="1"
            max="{{ total_pages }}"
            inputmode="numeric"
            pattern="[0-9]*"
            class="page-input"
          />
          of {{ total_pages }}
        </label>
      </form>

      {% if page < total_pages %}
        <a
          href="/all_quotes?order={{ sort_order }}&page={{ page+1 }}{% if selected_speaker %}&speaker={{ selected_speaker | urlencode }}{% endif %}{% if selected_tag %}&tag={{ selected_tag | urlencode }}{% endif %}"
          class="btn btn-ghost"
        >
          Next →
        </a>
      {% endif %}
    </div>
  {% endif %}
</section>

<script>
  document.addEventListener("focusin", (e) => {
    if (e.target.classList.contains("page-input")) {
      e.target.select();
    }
  });

  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("page-input")) {
      const form = e.target.closest("form");
      if (form) {
        form.submit();
      }
    }
  });

  document.addEventListener("blur", (e) => {
    if (e.target.classList.contains("page-input")) {
      const form = e.target.closest("form");
      if (form) {
        form.submit();
      }
    }
  }, true);

  const escapeHtml = (value) => {
    const div = document.createElement("div");
    div.textContent = value ?? "";
    return div.innerHTML;
  };

  const formatDate = (epochSeconds) => {
    const date = new Date((Number(epochSeconds) || 0) * 1000);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      day: "2-digit",
      month: "long",
      year: "numeric",
    }).format(date);
  };

  const formatTime = (epochSeconds) => {
    const date = new Date((Number(epochSeconds) || 0) * 1000);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    }).format(date);
  };

  const renderQuotes = (quotes) => {
    const grid = document.querySelector(".quote-grid");
    if (!grid) return;
    if (!quotes || quotes.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <h2>No quotes found</h2>
          <p>Try another speaker or clear the filter.</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = quotes
      .map((q) => {
        const authorList = Array.isArray(q.authors) ? q.authors.join(", ") : "";
        const context = q.context ? `<p class="quote-context">${escapeHtml(q.context)}</p>` : "";
        const tags = Array.isArray(q.tags) && q.tags.length
          ? `<div class="tag-row">${q.tags
              .map(
                (tag) =>
                  `<a class="tag-chip" href="/all_quotes?order=${encodeURIComponent(
                    (document.getElementById("order")?.value || "oldest")
                  )}&tag=${encodeURIComponent(String(tag))}">#${escapeHtml(tag)}</a>`,
              )
              .join("")}</div>`
          : "";
        return `
          <article class="quote-card">
            <div class="quote-text">“${escapeHtml(q.quote)}”</div>
            <div class="quote-meta">
              <span class="quote-author">${escapeHtml(authorList)}</span>
              <span class="dot">•</span>
              <span>${formatDate(q.timestamp)}</span>
              <span class="dot">•</span>
              <span>${formatTime(q.timestamp)}</span>
            </div>
            ${context}
            ${tags}
            <a href="/quote/${encodeURIComponent(q.id)}" class="btn btn-primary">
              View
            </a>
          </article>
        `;
      })
      .join("");
  };

  const renderPagination = (page, totalPages, speaker, order, tag) => {
    const container = document.querySelector(".pagination");
    if (!container) return;

    if (totalPages <= 1) {
      container.innerHTML = "";
      return;
    }

    const buildUrl = (targetPage) => {
      const params = new URLSearchParams();
      if (speaker) params.set("speaker", speaker);
      if (tag) params.set("tag", tag);
      if (order) params.set("order", order);
      params.set("page", String(targetPage));
      return `${window.location.pathname}?${params.toString()}`;
    };

    const prevLink =
      page > 1
        ? `<a href="${buildUrl(page - 1)}" class="btn btn-ghost">← Prev</a>`
        : "";
    const nextLink =
      page < totalPages
        ? `<a href="${buildUrl(page + 1)}" class="btn btn-ghost">Next →</a>`
        : "";

    const speakerField = speaker
      ? `<input type="hidden" name="speaker" value="${escapeHtml(speaker)}" />`
      : "";
    const orderField = order
      ? `<input type="hidden" name="order" value="${escapeHtml(order)}" />`
      : "";
    const tagField = tag
      ? `<input type="hidden" name="tag" value="${escapeHtml(tag)}" />`
      : "";

    container.innerHTML = `
      ${prevLink}
      <form method="get" class="page-jump">
        ${speakerField}
        ${orderField}
        ${tagField}
        <label>
          Page
          <input
            type="number"
            name="page"
            value="${page}"
            min="1"
            max="${totalPages}"
            inputmode="numeric"
            pattern="[0-9]*"
            class="page-input"
          />
          of ${totalPages}
        </label>
      </form>
      ${nextLink}
    `;
  };

  const applyOfflineParams = (params) => {
    const url = `${window.location.pathname}?${params.toString()}`;
    window.history.replaceState({}, "", url);
  };

  const getOfflineParams = () => {
    const params = new URLSearchParams(window.location.search);
    const speaker = params.get("speaker") || "";
    const tag = params.get("tag") || "";
    const order = params.get("order") || "oldest";
    const page = Number(params.get("page") || "1");
    const perPageAttr =
      document.querySelector(".all-quotes-page")?.dataset?.perPage || "9";
    const perPage = Number(perPageAttr) || 9;
    return { speaker, tag, order, page, perPage, params };
  };

  const loadOfflineQuotes = async (paramsOverride) => {
    if (!window.qbPwa?.getOfflineQuotePage) return false;
    const { speaker, tag, order, page, perPage, params } =
      paramsOverride || getOfflineParams();

    const data = await window.qbPwa.getOfflineQuotePage({
      speaker,
      tag,
      order,
      page,
      perPage,
    });
    if (!data) return false;

    renderQuotes(data.quotes);
    renderPagination(data.page, data.totalPages, speaker, order, tag);

    if (params) {
      params.set("page", String(data.page));
      if (speaker) {
        params.set("speaker", speaker);
      } else {
        params.delete("speaker");
      }
      if (tag) {
        params.set("tag", tag);
      } else {
        params.delete("tag");
      }
      if (order) {
        params.set("order", order);
      } else {
        params.delete("order");
      }
      applyOfflineParams(params);
    }

    return true;
  };

  const scheduleOfflineRender = (attempt = 0) => {
    if (navigator.onLine) return;
    if (window.qbPwa?.getOfflineQuotePage) {
      loadOfflineQuotes().then((ok) => {
        if (!ok && attempt < 12) {
          setTimeout(() => scheduleOfflineRender(attempt + 1), 300);
        }
      });
      return;
    }
    if (attempt < 12) {
      setTimeout(() => scheduleOfflineRender(attempt + 1), 300);
    }
  };

  const interceptOfflineControls = () => {
    const form = document.querySelector(".filter-form");
    const pagination = document.querySelector(".pagination");

    const handleSubmit = (event) => {
      if (navigator.onLine) return;
      event.preventDefault();
      const speaker = form?.querySelector("#speaker")?.value || "";
      const tag = form?.querySelector("#tag")?.value || "";
      const order = form?.querySelector("#order")?.value || "oldest";
      const pageInput = document.querySelector(".page-input");
      const page = Number(pageInput?.value || "1");
      const params = new URLSearchParams();
      if (speaker) params.set("speaker", speaker);
      if (tag) params.set("tag", tag);
      if (order) params.set("order", order);
      params.set("page", String(page));
      loadOfflineQuotes({
        speaker,
        tag,
        order,
        page,
        perPage: getOfflineParams().perPage,
        params,
      });
    };

    form?.addEventListener("submit", handleSubmit);
    pagination?.addEventListener("submit", handleSubmit);
  };

  window.addEventListener("offline", () => scheduleOfflineRender());
  window.addEventListener("load", () => {
    scheduleOfflineRender();
    interceptOfflineControls();
  });
</script>
{% endblock %}
