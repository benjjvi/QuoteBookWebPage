{% extends "base.html" %}

{% block title %}AI Screenplay{% endblock %}

{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='assets/css/ai.css') }}"
/>
{% endblock %}

{% block content %}
<section class="ai-page">
  <div class="ai-card">
    <div class="ai-header">
      <span class="eyebrow">AI Studio</span>
      <h1>Generating screenplay</h1>
      <p class="lead">
        Pulling the funniest quotes and weaving them into a screenplay.
      </p>
    </div>

    <div class="ai-loader">
      <div class="spinner" aria-hidden="true"></div>
      <p class="status" id="loadingText">Loading AI screenplay...</p>
    </div>
  </div>
</section>

<script>
  function decodeEscapes(text) {
    if (!text || typeof text !== "string") return text;
    return text
      .replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) =>
        String.fromCharCode(parseInt(hex, 16))
      )
      .replace(/\\n/g, "\n")
      .replace(/\\r/g, "\r")
      .replace(/\\t/g, "\t")
      .replace(/\\"/g, "\"")
      .replace(/\\\\/g, "\\");
  }

  fetch("/ai_screenplay")
    .then((res) => {
      if (!res.ok) throw new Error("Network response was not OK");
      return res.json();
    })
    .then((data) => {
      const screenplay = decodeEscapes(data.resp || "");
      const payload = JSON.stringify({ screenplay });
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "/ai_screenplay_render";

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "data";
      input.value = payload;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    })
    .catch((err) => {
      console.error(err);
      const text = document.getElementById("loadingText");
      text.innerText = "Error loading AI screenplay";
      text.classList.add("error");
    });
</script>
{% endblock %}
