{% extends "base.html" %}

{% block title %}AI Screenplay{% endblock %}

{% block extra_css %}
<link
  rel="stylesheet"
  href="/static/assets/css/ai.css"
/>
{% endblock %}

{% block content %}
<section class="ai-page">
  <div class="ai-card">
    <div class="ai-header">
      <span class="eyebrow">AI Studio</span>
      {% if ai_available %}
        <h1>Generating screenplay</h1>
        <p class="lead">
          Pulling the funniest quotes and weaving them into a screenplay.
        </p>
      {% else %}
        <h1>AI is unavailable</h1>
        <p class="lead">
          Set <code>OPENROUTER_KEY</code> in your environment to enable
          screenplay generation.
        </p>
        <a href="/" class="btn btn-ghost">Back home</a>
      {% endif %}
    </div>

    {% if ai_available %}
      <div class="ai-loader">
        <div class="spinner" aria-hidden="true"></div>
        <p class="status" id="loadingText" role="status" aria-live="polite">
          Loading AI screenplay...
        </p>
      </div>
    {% endif %}
  </div>
</section>

{% if ai_available %}
  <script>
    function decodeEscapes(text) {
      if (!text || typeof text !== "string") return text;
      return text
        .replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) =>
          String.fromCharCode(parseInt(hex, 16))
        )
        .replace(/\\n/g, "\n")
        .replace(/\\r/g, "\r")
        .replace(/\\t/g, "\t")
        .replace(/\\"/g, "\"")
        .replace(/\\\\/g, "\\");
    }

    fetch("/ai_screenplay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: "{{ ai_request_token }}" }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Network response was not OK");
        return res.json();
      })
      .then((data) => {
        const screenplay = decodeEscapes(data.resp || "");
        const payload = JSON.stringify({ screenplay });
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/ai_screenplay_render";

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "data";
        input.value = payload;

        const csrf = document.createElement("input");
        csrf.type = "hidden";
        csrf.name = "csrf_token";
        csrf.value = "{{ csrf_token() }}";

        form.appendChild(input);
        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
      })
      .catch((err) => {
        console.error(err);
        const text = document.getElementById("loadingText");
        text.innerText = "Error loading AI screenplay";
        text.classList.add("error");
      });
  </script>
{% endif %}
{% endblock %}
